<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Experience importing an existing Drupal site to Aegir &#8211; GoldSounds</title>
<meta name="description" content="The home of Dan Walmsley on the web">
<meta name="keywords" content="">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/site-logo.png">
<meta name="twitter:title" content="Experience importing an existing Drupal site to Aegir">
<meta name="twitter:description" content="The home of Dan Walmsley on the web">
<meta name="twitter:creator" content="@danwalmsley">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Experience importing an existing Drupal site to Aegir">
<meta property="og:description" content="The home of Dan Walmsley on the web">
<meta property="og:url" content="/general/programming/articles/nerdy/essays/experience-importing-an-existing-drupal-site-to-aegir">
<meta property="og:site_name" content="GoldSounds">

<meta name="google-site-verification" content="ctYPFVgrQdPlw-LQPjdbWiJ6JS1pxMR10J4JDhpPSxY">
<meta name="msvalidate.01" content="1695C38AA5D481B038F510859A4C6BDB">


<link rel="canonical" href="/general/programming/articles/nerdy/essays/experience-importing-an-existing-drupal-site-to-aegir">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="GoldSounds Feed">
<link rel="author" href="https://plus.google.com/108218105264306951840?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="/assets/js/vendor/jquery.githubRepoWidget.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop" itemscope itemtype="http://schema.org/SiteNavigationElement">
	    <ul>
	        
			<li>
				
					<a href="/">Home</a>
				 
			</li>
	        
			<li>
				
					<a href="/about">About</a>
				 
			</li>
	        
			<li>
				
					<a href="/blog">Blog</a>
				 
			</li>
	        
			<li>
				
					<a href="/songs">Songs</a>
				 
			</li>
	        
			<li>
				
					<a href="/art">Art</a>
				 
			</li>
	        
			<li>
				
					<a href="/code">Code</a>
				 
			</li>
	        
	        <li><a href="/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead" itemscope itemtype="http://schema.org/Organization">
	<div class="wrap">
		<a href="" class="site-logo" rel="home" title="GoldSounds" itemprop="url"><img src="/images/site-logo.png" width="200" height="200" alt="GoldSounds logo" class="animated fadeInUp" itemprop="logo"></a>
		<h1 class="site-title animated fadeIn"><a href="">GoldSounds</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">The home of Dan Walmsley on the web</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
  <article class="hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"></span>
        
          <h1 class="entry-title" itemprop="headline">Experience importing an existing Drupal site to Aegir</h1>
        
      </header>
      <footer class="entry-meta">
        <img src="/images/avatar.jpg" alt="Dan Walmsley photo" class="author-photo">
        <span class="author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">By <span itemprop="name" class="fn"><a href="/about" title="About Dan Walmsley" itemprop="url">Dan Walmsley</a></span></span>
        <span class="entry-date date published"><time datetime="2009-10-14T17:47:17-07:00" itemprop="datePublished"><i class="icon-calendar-empty"></i> October 14, 2009</time></span>
        
        

        <span><a href="/general/programming/articles/nerdy/essays/experience-importing-an-existing-drupal-site-to-aegir" rel="bookmark" title="Experience importing an existing Drupal site to Aegir" itemprop="url"><i class="icon-link"></i> Permalink</a></span>
      </footer>
      <div class="entry-content" itemprop="description">
        <div>

(Cross-posted from the <a href="http://groups.drupal.org/node/29450">Aegir group on Drupal.org</a>. Aegir is a brilliant new framework for managing web sites built in Drupal - upgrading, migrating, enabling, disabling and so, SO much more.)

Hi all,

I just wanted to share my experience migrating an existing site to Aegir, in the hope that others will find it illuminating and it will help them avoid some of the pitfalls I encountered.

Firstly, I made sure my site was completely checked into Subversion, and then checked it out on the Aegir host in the platforms directory as "mysite-1.0". I had decided after reading the available documentation that the best way to bring an existing site into Aegir is to import the whole Drupal distro as a platform and then migrate the "default" site into another existing platform (the latter step isn't really necessary, but I wanted to avoid having dozens of platforms for all my existing sites - defeats the point of Aegir somewhat).

Secondly, and before I imported the site, I renamed the "sites/default" directory to "sites/mysite.client2.gravityrail.net". Aegir ignores the "default" site. I then created a symlink, "sites/mysite.com", because that's how Aegir does it.

Third, I imported my database. Of course.

Now it was time to import the platform in Aegir. I crossed my fingers, toes and eyes (then uncrossed my eyes because I needed them to see the screen... and my fingers because I needed to type... so at this point only my toes were ensuring good luck came my way, and clearly toes aren't enough because...)

BAM! It worked!

Wha..?

Awesome!

Time to import the site. Breathe. Breathe. It can't be this easy, can it?

It wasn't.

Okay, here I've hit my first problem. I wanted the site to have a generated alias to mysite.com, but I think I either forgot or didn't see the entry box because this wasn't baked into the generated Apache config in config/vhost.d, and my site (I later found out) wouldn't appear when the DNS got changed. Whoops!

<strong>Lesson 1</strong>: Make <em>sure</em> you enter your domain aliases when you import the site in Aegir.

Secondly, the import task failed because of a missing file on a mysqldump, "/dev/fd/3". Turns out on Debian Lenny you need to make sure you've got udev installed so the smart mysql script can create temporary devices containing mysql credentials.

<strong>Lesson 2</strong>: On Debian, make sure you have udev installed.

But my script was halting at another point now. It was complaining that I wasn't using a password for MySQL! That's weird... checked my settings.php, all seems well. Turns out the issue is that my password started with a "#" symbol. Turns out one of our components here doesn't like certain punctuation in passwords. Similar problems will occur if your password contains } or ) or various other symbols that could be interpreted as PHP/shell/MySQL delimiters of various kinds.

<strong>Lesson 3</strong>: Don't include punctuation in your passwords, for now. Hopefully this will be fixed shortly.

Ran it again. Got a bunch of permissions errors on files, typical stuff and I fixed it.

So, finally I got the migration script to run but, critically, by this point I was running it from the command line so I could see this debug output. This has ramifications later.

When the migration script completed, there were a lot of errors to do with missing packages. See, I'd assumed that drush or provision or one of the other smart tools underlying this system would detect the modules in the source platform and, if they were missing in the target platform, it would automatically download them.

Whoops, nope, turns out that's not the case, for a whole bunch of really good reasons.

<strong>Lesson 4</strong>: Make sure you have all the required packages installed on your target platform before you migrate.

At this point I decided to flex my Unix command-line muscles and concocted a simple command line to port and enable the packages. As we'll find out, I'm not as smart as I thought I was.
<div><code>cp -R source-platform/sites/all/modules target-platform/sites/all
ls target-platform/sites/all/modules | xargs -y enable</code></div>
See, this assumes there is just one module per directory name, and that the name of the module is the name of the directory. As y'all in Drupal-land know, this just ain't so. Chalk one up for Java-guy-learning-Drupal.

So, thinking I was done and readying my martini, monocle, slippers, and wallet for the inevitable glory and prestige, I pointed my browser at the site: mysite.clientX.gravityrail.net.

[GARBAGE FILLS THE SCREEN]

I dropped the martini, the monocle fell out, and my crossed-toes drew blood inside my tartan slippers as I surveyed the damage. Missing images, ill-rendered Javascript, formatting completely gone, fonts in TIMES NEW BLOODY ROMAN. This was no good, no good at all. I was building a professional site, not MySpace. Back to the typing-board.

Okay, time for a few more lessons:

<strong>Lesson 5</strong>: Copy the themes, not just the modules. I had forgotten that my site's theme was a Zen subtheme, and you can't have a subtheme without the super-theme.

<strong>Lesson 6</strong>: As above, enable all the modules you need. Though this shouldn't be necessary if the modules are actually present in the target platform when you migrate - Aegir was clearly making a good-faith effort to enable everything when I ran the migrate script.

<strong>Lesson 7</strong>: If you <strong>don't</strong> migrate using the web interface, then your site will be copied as the Aegir user, not as www-data. Then you'll find that suddenly imagecache can't create thumbnails of your images, for example. At the very least, do a "chgrp -R www-data sites/mysite.com/files". Hopefully this will be enough.

<strong>Lesson 8</strong>: There are plenty of Drupal modules that hate having their site renamed. ImageAPI / ImageCache is one of them. Moving from "default" to "mysite.com" meant that I had to go into the database (shudder) and do an "UPDATE files SET filepath = REPLACE(filepath,"sites/default","sites/mysite.com");" so imagecache could find the files. <strong>This is a design flaw in the way that Drupal or this module handles files, and multi-site should be fixed to handle it</strong>. I strongly believe no files should have their paths stored relative to the system root in a multi-site framework, for obvious reasons.

So, after fixing permissions, filepaths, enabling required modules, testing and re-testing, I had my site imported and migrated onto Pressflow 6.14.56 and working well.

Then my client changed their DNS, and the site didn't appear, and they got angry and changed their DNS back. Because on my final successful migration, Aegir rewrote my apache configuration without the Site Alias of mysite.com.

We re-launch today. Second time lucky. Aegir still has some rough edges for newbies, but I feel really excited that I finally have a consistent way of managing all my sites. Migrating your existing sites into Aegir is totally worth it, and I hope that my lessons above help a few people to get into this wonderful new world.</div>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/general/articles/nerdy/essays/obtuse/the-number-one-hit-for-arsehole" class="btn" title="The Number One Hit for "Arsehole"">Previous article</a>
      
      
        <a href="/comedy/nerdy/alarmist-banner-fail" class="btn" title="Alarmist Banner Fail">Next article</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2013 Dan Walmsley. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/danwalmsley" title="Dan Walmsley on Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	<a href="http://facebook.com/dan.walmsley.exists" title="Dan Walmsley on Facebook" target="_blank"><i class="icon-facebook icon-2x"></i></a>
	<a href="https://plus.google.com/108218105264306951840" title="Dan Walmsley on Google+" target="_blank"><i class="icon-google-plus icon-2x"></i></a>
	<a href="http://linkedin.com/in/danwalmsley" title="Dan Walmsley on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	
	<a href="http://instagram.com/goldsounds" title="Dan Walmsley on Instagram" target="_blank"><i class="icon-instagram icon-2x"></i></a>
	
	<a href="http://github.com/gravityrail" title="Dan Walmsley on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/main.min.js"></script>



</body>
</html>
